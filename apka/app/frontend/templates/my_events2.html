<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoteWriter</title>
  <link rel="icon" type="image/x-icon" href="static/logoo.png">
  <link rel="stylesheet" href="{{ url_for('static', filename='stylesEvents.css') }}">
</head>
<body>
  <div class="top-nav">
    <a href="/" class="back-to-home">Back to Home</a>
  </div>
  <div class="container">
    <h1>Twoje wydarzenia Teams</h1>
    <button id="loginTeamsBtn" class="btn"> Zaloguj si w Teams</button>
    <button id="loadTeamsEventsBtn" class="btn"> Zaaduj wydarzenia</button>
    <div class="events-list">
        <ul id="teamsList"></ul>
    </div>
  </div>
  <script>
    const loginTeamsBtn = document.getElementById("loginTeamsBtn");
    const loadTeamsEventsBtn = document.getElementById("loadTeamsEventsBtn");
    const teamsList = document.getElementById("teamsList");

    // A) Przekieruj do /teams/login
    loginTeamsBtn.addEventListener("click", () => {
      window.location.href = "/teams/login";
    });

    // B) Po zalogowaniu w callbacku - user wr贸ci na /teams/callback -> app zapisuje access_token do session
    // C) P贸藕niej klikamy "Zaaduj wydarzenia"
    loadTeamsEventsBtn.addEventListener("click", () => {
      fetch("/teams-events")
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert("Bd: " + data.error);
            return;
          }
          teamsList.innerHTML = "";
          data.forEach(evt => {
            // Ka偶dy event to obiekt np. { id, subject, start, attendees, ... }
            const li = document.createElement("li");
            li.textContent = `ID: ${evt.id}, Temat: ${evt.subject}`;

            const showAttendeesBtn = document.createElement("button");
            showAttendeesBtn.textContent = "Poka偶 uczestnik贸w";
            showAttendeesBtn.addEventListener("click", () => {
              loadTeamsEventAttendees(evt.id);
            });

            li.appendChild(showAttendeesBtn);
            teamsList.appendChild(li);
          });
        })
        .catch(err => console.error(err));
    });

    // D) Poka偶 uczestnik贸w (czyli pobierz szczeg贸 eventu: /teams-event-details?eventId=xxx)
    function loadTeamsEventAttendees(eventId) {
      fetch(`/teams-event-details?eventId=${eventId}`)
        .then(res => res.json())
        .then(evtData => {
          if (evtData.error) {
            alert("Bd: " + evtData.error);
            return;
          }
          // evtData np. { subject: "...", attendees: [{ emailAddress: { address: "..." }}], ... }
          const attendees = evtData.attendees || [];
          if (attendees.length === 0) {
            alert("Brak");
            return;
          }
          // Wycigamy list emaili
          const emails = attendees.map(a => a.emailAddress.address);
          alert("Uczestnicy: " + emails.join(", "));

          // Dodaj guzik do wysyania maili
          const sendEmailBtn = document.createElement("button");
          sendEmailBtn.textContent = "Wylij e-mail do wszystkich";
          sendEmailBtn.addEventListener("click", () => {
            fetch("/send_invitations", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                recipients: emails,
                subject: "Temat wiadomosci"
              })
            })
            .then(resp => resp.json())
            .then(respData => {
              if (respData.error) {
                alert("Bd: " + respData.error);
              } else {
                alert("Wiadomoci wysane!");
              }
            })
            .catch(err => {
              console.error(err);
              alert("Bd podczas wysyania");
            });
          });

          document.body.appendChild(sendEmailBtn);
        })
        .catch(err => console.error(err));
    }
  </script>
</body>
</html>
